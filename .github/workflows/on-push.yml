name: Build FrankenPHP with Souin

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet de d√©clencher manuellement le workflow

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PHP_VERSION: 8.3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build FrankenPHP Docker image
        id: build_image
        run: |
          docker build --target builder --build-arg PHP_VERSION=${{ env.PHP_VERSION }} -t frankenphp-builder .
          CONTAINER_ID=$(docker create frankenphp-builder)
          docker cp $CONTAINER_ID:/usr/local/bin/frankenphp ./frankenphp
          docker rm $CONTAINER_ID
          chmod +x ./frankenphp

      - name: Upload FrankenPHP binary as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: frankenphp-binary
          path: ./frankenphp

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: main
          release_name: Latest Main Build
          body: FrankenPHP binary built from main branch
          draft: false
          prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./frankenphp
          asset_name: frankenphp
          asset_content_type: application/octet-stream
