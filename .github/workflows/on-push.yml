name: Build FrankenPHP with Souin

on:
  push:
    branches:
      - main
  workflow_dispatch: # Permet de déclencher manuellement le workflow

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PHP_VERSION: 8.3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build FrankenPHP Docker image
        id: build_image
        run: |
          # Construit l'image Docker, en se concentrant sur l'étape 'franken-builder'
          docker build --target builder --build-arg PHP_VERSION=${{ env.PHP_VERSION }} -t frankenphp-builder .
          
          # Crée un conteneur temporaire à partir de l'image construite
          CONTAINER_ID=$(docker create frankenphp-builder)
          
          # Copie le binaire depuis le conteneur vers le runner
          docker cp $CONTAINER_ID:/usr/local/bin/frankenphp ./frankenphp
          
          # Supprime le conteneur temporaire
          docker rm $CONTAINER_ID
          
          # Rend le binaire exécutable (important pour la prochaine étape)
          chmod +x ./frankenphp

      - name: Upload FrankenPHP binary as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: frankenphp-binary
          path: ./frankenphp

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ./frankenphp
          asset_name: frankenphp
          tag: main-${{ github.sha }}  # Utilise le hash du commit
          overwrite: true
          body: "FrankenPHP binary built from commit ${{ github.sha }}"
          release_name: "Build ${{ github.sha }}"
